<!doctype html>
<html lang="en">
<head>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "Simulations" }}</title>
  <meta name="description" content="PhET-style interactive simulation for green chemistry metrics." />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
 <style>
  .knob { accent-color: #059669; } /* emerald-600 */
  .badge { font-size: 10px; border-radius: 9999px; padding: 2px 8px; }
  canvas.dial { display:block; width:100% !important; height:100% !important; max-width:100%; max-height:100%; }
  .dial-wrap { width: 10rem; height: 10rem; }       /* ~160px */
  
  /* Collapsible sections */
  .section-toggle {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-toggle::before {
    content: '‚ñº';
    font-size: 10px;
    transition: transform 0.2s;
  }
  .section-toggle.collapsed::before {
    transform: rotate(-90deg);
  }
  .section-content {
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .section-content.hidden {
    max-height: 0;
  }
  
  @media (min-width: 768px) {
    .dial-wrap { width: 12rem; height: 12rem; }     /* ~192px on md+ */
  }
  
  /* Custom styled sliders for Time, Temperature and Pressure with dynamic fill */
  #cond_time,
  #cond_temp,
  #cond_pressure {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: #E5E7EB;
    outline: none;
    margin: 0;
    padding: 0;
  }
  
  /* Slider thumb styling for Webkit browsers (Chrome, Safari) */
  #cond_time::-webkit-slider-thumb,
  #cond_temp::-webkit-slider-thumb,
  #cond_pressure::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 2px solid #6B7280;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    margin-top: -6px; /* Centers 20px thumb on 8px track: (20-8)/2 = 6px */
  }
  
  /* Slider thumb styling for Firefox */
  #cond_time::-moz-range-thumb,
  #cond_temp::-moz-range-thumb,
  #cond_pressure::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 2px solid #6B7280;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: none;
  }
  
  /* Track fill for Webkit */
  #cond_time::-webkit-slider-runnable-track,
  #cond_temp::-webkit-slider-runnable-track,
  #cond_pressure::-webkit-slider-runnable-track {
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: transparent;
  }
  
  /* Track styling for Firefox */
  #cond_time::-moz-range-track,
  #cond_temp::-moz-range-track,
  #cond_pressure::-moz-range-track {
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: transparent;
    border: none;
  }
  
  /* Progress fill for Firefox */
  #cond_time::-moz-range-progress,
  #cond_temp::-moz-range-progress,
  #cond_pressure::-moz-range-progress {
    height: 8px;
    border-radius: 5px;
  }
</style>

</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <a class="flex items-center gap-2" href="/">
        <div class="h-8 w-8 rounded-xl bg-emerald-600"></div>
        <span class="text-xl font-semibold">Green Toolkit</span>
      </a>
      <nav class="flex gap-4 text-sm">
        <a class="hover:text-emerald-700" href="/">Home</a>
        <a class="hover:text-emerald-700" href="/tools">Tools</a>
        <a class="text-emerald-700 font-medium" href="/simulate">Simulations</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Left: Controls -->
    <section class="rounded-2xl bg-white p-5 shadow-sm border md:col-span-1">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-semibold">Tools & Calculators</h1>
        <button id="load-example" class="text-xs rounded-md bg-gray-100 px-3 py-1.5 hover:bg-gray-200">Load Aspirin Example</button>
      </div>
      <p class="text-xs text-gray-600 mt-1">Tweak variables; visuals update instantly.</p>

      <!-- Reaction Name -->
      <div class="mt-3">
        <label class="grid">
          <span class="text-xs text-gray-700 mb-1">Reaction Name</span>
          <input id="reaction_name" type="text" class="border rounded-lg px-3 py-2 text-sm" placeholder="Enter reaction name..." title="Reaction Name">
        </label>
      </div>

    <!-- Product -->
<div class="mt-4 border rounded-lg p-3">
  <h2 class="text-sm font-medium mb-2 section-toggle" onclick="toggleSection(this)">Product</h2>
  <div class="section-content">
    <div id="products" class="grid gap-2"></div>
    <button id="add-product" class="mt-2 w-full rounded bg-emerald-600 text-white text-xs px-2 py-1 hover:bg-emerald-700">+ Add</button>
  </div>
</div>
      <!-- Reactants (compact card list) -->
      <div class="mt-5 border rounded-lg p-3">
        <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Reactants</h2>
        <div class="section-content hidden">
          <div id="reactants" class="grid gap-2"></div>
          <button id="add-reactant" class="mt-2 w-full rounded bg-emerald-600 text-white text-xs px-2 py-1 hover:bg-emerald-700">+ Add</button>
        </div>
      </div>

      <!-- Solvents (compact card list) -->
      <div class="mt-5 border rounded-lg p-3">
        <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Solvents</h2>
        <div class="section-content hidden">
          <div id="solvents" class="grid gap-2"></div>
          <button id="add-solvent" class="mt-2 w-full rounded bg-emerald-600 text-white text-xs px-2 py-1 hover:bg-emerald-700">+ Add</button>
        </div>
      </div>
       <!-- Catalysts (compact card list) -->
<div class="mt-5 border rounded-lg p-3">
  <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Catalysts</h2>
  <div class="section-content hidden">
    <div id="catalysts" class="grid gap-2"></div>
    <button id="add-catalyst" class="mt-2 w-full rounded bg-emerald-600 text-white text-xs px-2 py-1 hover:bg-emerald-700">+ Add</button>
  </div>
</div>

      <!-- Workup (sliders like PhET) -->
      <div class="mt-5 border rounded-lg p-3">
        <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Water & Workup</h2>
        <div class="section-content hidden">
        <div class="grid gap-4">
        <div>
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium">Aqueous washes (g)</label>
            <span id="lbl_washes" class="text-xs text-gray-500">0 g</span>
          </div>
          <input id="workup_washes" class="w-full knob" type="range" min="0" max="500" value="0">
        </div>

        <div>
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium">Drying agents (g)</label>
            <span id="lbl_drying" class="text-xs text-gray-500">0 g</span>
          </div>
          <input id="workup_drying" class="w-full knob" type="range" min="0" max="10" value="0" step="0.1">
        </div>
        </div>
        </div>
      </div>

        <!-- Conditions: vertical order Mode ‚Üí Time ‚Üí Temp -->
        <div class="mt-5 border rounded-lg p-3">
        <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Conditions</h2>
        <div class="section-content hidden">
        <div class="grid gap-3">
          <label class="grid">
            <span class="text-sm font-medium">Mode</span>
            <select id="cond_mode" class="border rounded-lg px-2 py-2">
              <option value="hotplate">üî• Hotplate</option>
              <option value="microwave">‚ö° Microwave</option>
              <option value="reflux">‚ôª Reflux</option>
              <option value="other">Other</option>
            </select>
          </label>

          <label class="grid">
            <span class="text-sm font-medium">Time (h)</span>
            <input id="cond_time" type="range" min="0" max="72" step="0.1" value="1.5" class="knob">
            <span id="lbl_time" class="text-xs text-gray-500">1.5 h</span>
          </label>

          <label class="grid">
            <span class="text-sm font-medium">Temp (¬∞C)</span>
            <input id="cond_temp" type="range" min="0" max="1000" value="70" class="knob">
            <span id="lbl_temp" class="text-xs text-gray-500">70 ¬∞C</span>
          </label>

          <label class="grid">
            <span class="text-sm font-medium">Pressure (atm)</span>
            <input id="cond_pressure" type="range" min="0" max="1000" value="1" class="knob">
            <span id="lbl_pressure" class="text-xs text-gray-500">1 atm</span>
          </label>
        </div>
        </div>
        </div>

        <!-- Separation/Purification -->
        <div class="mt-5 border rounded-lg p-3">
        <h2 class="text-sm font-medium mb-2 section-toggle collapsed" onclick="toggleSection(this)">Separation/Purification</h2>
        <div class="section-content hidden">
        <div class="grid gap-3">
          <label class="grid">
            <span class="text-sm font-medium">Method</span>
            <select id="sep_method" class="border rounded-lg px-2 py-2">
              <option value="distillation">üß™ Distillation</option>
              <option value="evaporation">üí® Evaporation</option>
              <option value="crystallization">‚ùÑÔ∏è Crystallization</option>
              <option value="chromatography">üî¨ Chromatography</option>
              <option value="other">Other</option>
            </select>
          </label>
        </div>
        </div>
        </div>

        <label class="inline-flex items-center gap-2 mt-4">
          <input id="opt_pmi_recovered" type="checkbox" class="h-4 w-4">
          <span class="text-xs">Include recovered solvent in PMI numerator</span>
        </label>
      </div>


      <div class="mt-5 flex items-center gap-2">
        <button id="simulate" class="rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm hover:bg-emerald-700">Run Simulation</button>
        <button id="reset" class="rounded-lg bg-gray-200 px-4 py-2 text-sm hover:bg-gray-300">Reset</button>
        <span id="sim-error" class="text-xs text-red-600 hidden"></span>
      </div>
    </section>

    <!-- Right: Metrics (top) + Visuals (beneath) -->
<section class="rounded-2xl bg-white p-5 shadow-sm border md:col-span-2">
  <!-- Raw numbers FIRST -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center text-sm">
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Atom Economy</div>
      <div id="r_ae" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">PMI</div>
      <div id="r_pmi" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">E-factor</div>
      <div id="r_ef" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Water (mL/g)</div>
      <div id="r_water" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Energy (Wh/g)</div>
      <div id="r_energy" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">RME (%)</div>
      <div id="r_rme" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Carbon Efficiency (%)</div>
      <div id="r_ce" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Stoichiometric Factor</div>
      <div id="r_sf" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Solvent Intensity (SI)</div>
      <div id="r_si" class="text-2xl font-semibold">‚Äî</div>
    </div>
    <div class="border rounded-lg p-3">
      <div class="text-gray-500 text-xs">Carbon Footprint (g CO‚ÇÇ/g)</div>
      <div id="r_cf" class="text-2xl font-semibold">‚Äî</div>
    </div>
  </div>

  <!-- Visuals BENEATH -->
  <div class="mt-6 grid gap-4 md:grid-cols-2">
    <!-- Metric bars -->
    <div class="border rounded-xl p-4 md:col-span-2">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-medium">Impact Metrics</h2>
        <div class="flex gap-1">
          <span class="badge" style="background-color: #10B981; color: white;">good</span>
          <span class="badge" style="background-color: #F59E0B; color: white;">ok</span>
          <span class="badge" style="background-color: #EF4444; color: white;">needs work</span>
        </div>
      </div>
      <canvas id="metricsChart" class="mt-4"></canvas>
    </div>
<!-- Efficiency dials (AE, RME, Carbon Efficiency) -->
<div class="border rounded-xl p-4 md:col-span-2 overflow-hidden">
  <div class="flex items-center justify-between">
    <h2 class="text-sm font-medium">Efficiency Metrics</h2>
    <div class="flex gap-1">
      <span class="badge" style="background-color: #10B981; color: white;">good</span>
      <span class="badge" style="background-color: #F59E0B; color: white;">ok</span>
      <span class="badge" style="background-color: #EF4444; color: white;">needs work</span>
    </div>
  </div>
  <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-8 place-items-center">
    <div class="flex flex-col items-center">
      <div class="dial-wrap"><canvas id="dialAE"  class="dial"></canvas></div>
      <div class="mt-2 text-sm font-medium text-gray-800">Atom Economy</div>
    </div>
    <div class="flex flex-col items-center">
      <div class="dial-wrap"><canvas id="dialRME" class="dial"></canvas></div>
      <div class="mt-2 text-sm font-medium text-gray-800">RME</div>
    </div>
    <div class="flex flex-col items-center">
      <div class="dial-wrap"><canvas id="dialCE"  class="dial"></canvas></div>
      <div class="mt-2 text-sm font-medium text-gray-800">Carbon Efficiency</div>
    </div>
  </div>
</div>
    <!-- Sankey -->
    <div class="border rounded-xl p-4 md:col-span-2">
      <h2 class="text-sm font-medium">Mass Flow</h2>
      <div id="sankey" class="mt-4"></div>
    </div>

    <!-- Beaker animation -->
    <div class="border rounded-xl p-4 md:col-span-2">
      <h2 class="text-sm font-medium">Beaker (Product vs Waste vs Recovered)</h2>
      <div class="mt-3 flex items-end gap-6">
        <svg id="beaker" width="220" height="180">
          <rect x="10" y="10" width="200" height="160" rx="8" ry="8" fill="none" stroke="#374151" stroke-width="2"/>
          <rect id="fill-recovered" x="12" y="168" width="196" height="0" fill="#A7F3D0"></rect>
          <rect id="fill-waste"     x="12" y="168" width="196" height="0" fill="#FECACA"></rect>
          <rect id="fill-product"   x="12" y="168" width="196" height="0" fill="#93C5FD"></rect>
        </svg>
        <div class="text-xs text-gray-600">
          <div><span class="inline-block w-3 h-3 mr-2" style="background:#93C5FD"></span>Product</div>
          <div><span class="inline-block w-3 h-3 mr-2" style="background:#FECACA"></span>Waste (non-recovered)</div>
          <div><span class="inline-block w-3 h-3 mr-2" style="background:#A7F3D0"></span>Recovered solvent</div>
        </div>
      </div>
    </div>

    <!-- AI Suggestions -->
    <div class="border rounded-xl p-4 md:col-span-2">
      <h2 class="text-sm font-medium">AI Suggestions</h2>
      <div id="ai-suggestions" class="mt-3 text-sm text-gray-600">
        <p class="italic">Run a simulation to get AI-powered suggestions for improving your green chemistry metrics.</p>
      </div>
    </div>

    <!-- Generate PDF Button -->
    <div class="md:col-span-2 flex justify-center">
      <button id="generate-pdf" class="hidden rounded-lg bg-emerald-600 text-white px-6 py-3 text-sm font-medium hover:bg-emerald-700 shadow-md">Generate PDF Report</button>
    </div>
  </div>
</section>

  </main>

  <footer class="mt-10 border-t">
    <div class="mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500">
      ¬© <span id="year"></span> Green Toolkit ‚Ä¢ Simulations
    </div>
  </footer>

  <!-- Logic -->
  <script>
    // Helpers
    const $  = (sel) => document.querySelector(sel);
    const el = (tag, cls) => { const x = document.createElement(tag); if (cls) x.className = cls; return x; };
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
    const setTxt = (id, t) => { const e = $(id); if (e) e.textContent = t; };

    // Toggle collapsible sections
    function toggleSection(header) {
      header.classList.toggle('collapsed');
      // Find the section-content - it might be the next sibling of the header or the parent's next sibling
      let content = header.nextElementSibling;
      if (!content || !content.classList.contains('section-content')) {
        // If toggle is inside a flex container, look for parent's next sibling
        content = header.parentElement.nextElementSibling;
      }
      if (content && content.classList.contains('section-content')) {
        content.classList.toggle('hidden');
      }
    }

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Reactant / solvent compact cards
    const productsBox = $('#products');
    const reactantsBox = $('#reactants');
    const solventsBox = $('#solvents');
    const catalystsBox = $('#catalysts');
    
    function productCard(data = {}) {
      const card = el('div', 'border rounded-lg p-3 grid gap-2');
      card.innerHTML = `
        <!-- Row 1: Name -->
        <div class="flex flex-wrap items-end gap-6">
          <label class="grid flex-1">
            <span class="text-xs text-gray-700">Name</span>
            <input class="p_name border rounded-lg px-3 py-2 text-xs"
                   placeholder="aspirin" title="Name"
                   value="${data.name||''}">
          </label>
        </div>

        <!-- Row 2: MW | Mass -->
        <div class="flex flex-wrap items-end gap-6">
          <label class="grid">
            <span class="text-xs text-gray-700">MW (g/mol)</span>
            <input class="p_mw border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
                   placeholder="MW" title="MW (g/mol)"
                   value="${data.mw||''}">
          </label>
          <label class="grid">
            <span class="text-xs text-gray-700">Mass (g)</span>
            <input class="p_mass border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
                   placeholder="Mass g" title="Mass (g)"
                   value="${data.actual_mass_g||''}">
          </label>
        </div>

        <!-- Row 3: C atoms | remove -->
        <div class="flex flex-wrap items-end gap-6">
          <label class="grid">
            <span class="text-xs text-gray-700">C atoms (optional)</span>
            <input class="p_c border rounded-lg px-3 py-2 text-xs w-24" type="number" min="0"
                   placeholder="C atoms" title="C atoms"
                   value="${data.carbon_atoms||''}">
          </label>
          <button type="button" class="rmv rounded border px-3 py-2 text-xs">x</button>
        </div>
      `;
      card.querySelector('.rmv').onclick = () => card.remove();
      return card;
    }
    
     function reactantCard(data = {}) {
  const card = el('div', 'border rounded-lg p-3 grid gap-2');
  card.innerHTML = `
    <!-- Row 1: Name | MW -->
    <div class="flex flex-wrap items-end gap-6">
      <label class="grid">
        <span class="text-xs text-gray-700">Name</span>
        <input class="r_name border rounded-lg px-3 py-2 text-xs w-32"
               placeholder="name" title="Name"
               value="${data.name||''}">
      </label>
      <label class="grid">
        <span class="text-xs text-gray-700">MW (g/mol)</span>
        <input class="r_mw border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="MW" title="MW (g/mol)"
               value="${data.mw||''}">
      </label>
    </div>

    <!-- Row 2: Mass | C atoms -->
    <div class="flex flex-wrap items-end gap-6">
      <label class="grid">
        <span class="text-xs text-gray-700">Mass (g)</span>
        <input class="r_mass border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="mass g" title="Mass (g)"
               value="${data.mass_g||''}">
      </label>
      <label class="grid">
        <span class="text-xs text-gray-700">C atoms</span>
        <input class="r_c border rounded-lg px-3 py-2 text-xs w-24" type="number" min="0"
               placeholder="C atoms" title="C atoms"
               value="${data.carbon_atoms||''}">
      </label>
    </div>

    <!-- Row 3: eq used | eq stoich | remove -->
    <div class="flex flex-wrap items-end gap-6">
      <label class="grid">
        <span class="text-xs text-gray-700">eq used</span>
        <input class="r_eu border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="eq used" title="eq used"
               value="${data.eq_used||''}">
      </label>
      <label class="grid">
        <span class="text-xs text-gray-700">eq stoich</span>
        <input class="r_es border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="eq stoich" title="eq stoich"
               value="${data.eq_stoich||''}">
      </label>
      <button type="button" class="rmv rounded border px-3 py-2 text-xs">x</button>
    </div>
  `;
  card.querySelector('.rmv').onclick = () => card.remove();
  return card;
}

  function solventCard(data = {}) {
    const card = el('div', 'border rounded-lg p-3 grid gap-2');
    card.innerHTML = `
      <!-- Row 1: Solvent | Mass (g) -->
      <div class="flex flex-wrap items-end gap-6">
        <label class="grid">
          <span class="text-xs text-gray-700">Solvent</span>
          <input class="s_name border rounded-lg px-3 py-2 text-xs w-32"
                 placeholder="solvent" title="Solvent"
                 value="${data.name||''}">
        </label>
        <label class="grid">
          <span class="text-xs text-gray-700">Mass (g)</span>
          <input class="s_mass border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
                 placeholder="Mass g" title="Mass (g)"
                 value="${data.mass_g||''}">
        </label>
      </div>

      <!-- Row 2: B.P | % rec | remove -->
      <div class="flex flex-wrap items-end gap-6">
        <label class="grid">
          <span class="text-xs text-gray-700">B.P (¬∞C)</span>
          <input class="s_bp border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any"
                 placeholder="B.P" title="Boiling Point (¬∞C)"
                 value="${data.boiling_point||''}">
        </label>
        <label class="grid">
          <span class="text-xs text-gray-700">% rec</span>
          <input class="s_rec border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0" max="100"
                 placeholder="% rec" title="% rec"
                 value="${data.recovery_pct||''}">
        </label>
        <button type="button" class="rmv rounded border px-3 py-2 text-xs">x</button>
      </div>
    `;
    card.querySelector('.rmv').onclick = () => card.remove();
    return card;
  }
  function catalystCard(data = {}) {
  const card = el('div', 'border rounded-lg p-3 grid gap-2');
  card.innerHTML = `
    <!-- Row 1: Name | MW -->
    <div class="flex flex-wrap items-end gap-6">
      <label class="grid">
        <span class="text-xs text-gray-700">Name</span>
        <input class="c_name border rounded-lg px-3 py-2 text-xs w-32"
               placeholder="catalyst" title="Name"
               value="${data.name||''}">
      </label>
      <label class="grid">
        <span class="text-xs text-gray-700">MW (g/mol)</span>
        <input class="c_mw border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="MW" title="MW (g/mol)"
               value="${data.mw||''}">
      </label>
    </div>

    <!-- Row 2: Mass | remove -->
    <div class="flex flex-wrap items-end gap-6">
      <label class="grid">
        <span class="text-xs text-gray-700">Mass (g)</span>
        <input class="c_mass border rounded-lg px-3 py-2 text-xs w-24" type="number" step="any" min="0"
               placeholder="Mass g" title="Mass (g)"
               value="${data.mass_g||''}">
      </label>
      <button type="button" class="rmv rounded border px-3 py-2 text-xs">x</button>
    </div>
  `;
  card.querySelector('.rmv').onclick = () => card.remove();
  return card;
}

    // Add default cards
    if (!productsBox.children.length) productsBox.appendChild(productCard());
    if (!reactantsBox.children.length) reactantsBox.appendChild(reactantCard());
    if (!solventsBox.children.length)  solventsBox.appendChild(solventCard());
    if (!catalystsBox.children.length) catalystsBox.appendChild(catalystCard());
    // Add buttons
    $('#add-product').onclick = () => productsBox.appendChild(productCard());
    $('#add-reactant').onclick = () => reactantsBox.appendChild(reactantCard());
    $('#add-solvent').onclick  = () => solventsBox.appendChild(solventCard());
    $('#add-catalyst').onclick = () => catalystsBox.appendChild(catalystCard());

    // Labels for sliders with dynamic color fill
    function bindLabel(inputId, labelId, suffix) {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      if (!input || !label) return;
      const upd = () => label.textContent = `${input.value} ${suffix}`;
      input.addEventListener('input', upd); upd();
    }
    
    // Dynamic color fill for Time and Temperature sliders
    function updateSliderFill(slider) {
      const min = parseFloat(slider.min) || 0;
      const max = parseFloat(slider.max) || 100;
      const value = parseFloat(slider.value) || 0;
      const percentage = ((value - min) / (max - min)) * 100;
      
      // Determine color based on percentage
      let color;
      if (percentage <= 33.33) {
        color = '#10B981'; // green - good
      } else if (percentage <= 66.66) {
        color = '#F59E0B'; // yellow - ok
      } else {
        color = '#EF4444'; // red - needs work
      }
      
      // Create gradient: colored fill up to current value, gray for remainder
      const gradient = `linear-gradient(to right, ${color} 0%, ${color} ${percentage}%, #E5E7EB ${percentage}%, #E5E7EB 100%)`;
      slider.style.background = gradient;
    }
    
    // Initialize color-coded sliders
    const timeSlider = document.getElementById('cond_time');
    const tempSlider = document.getElementById('cond_temp');
    const pressureSlider = document.getElementById('cond_pressure');
    
    if (timeSlider) {
      updateSliderFill(timeSlider);
      timeSlider.addEventListener('input', () => updateSliderFill(timeSlider));
    }
    
    if (tempSlider) {
      updateSliderFill(tempSlider);
      tempSlider.addEventListener('input', () => updateSliderFill(tempSlider));
    }
    
    if (pressureSlider) {
      updateSliderFill(pressureSlider);
      pressureSlider.addEventListener('input', () => updateSliderFill(pressureSlider));
    }
    
    bindLabel('workup_washes', 'lbl_washes', 'g');
    bindLabel('workup_drying', 'lbl_drying', 'g');
    bindLabel('cond_time', 'lbl_time', 'h');
    bindLabel('cond_temp', 'lbl_temp', '¬∞C');
    bindLabel('cond_pressure', 'lbl_pressure', 'atm');

    // Example
$('#load-example').onclick = () => {
  // Reaction Name
  $('#reaction_name').value = 'Synthesis of Aspirin';
  
  // Product
  productsBox.innerHTML = '';
  productsBox.appendChild(productCard({
    name:'aspirin', mw:180.16, actual_mass_g:10, carbon_atoms:9
  }));

  // Reactants (now include carbon + equivalents)
  reactantsBox.innerHTML = '';
  reactantsBox.appendChild(reactantCard({
    name:'salicylic acid', mw:138.12, mass_g:8.3,
    carbon_atoms:7, eq_used:1.0, eq_stoich:1.0
  }));
  reactantsBox.appendChild(reactantCard({
    name:'acetic anhydride', mw:102.09, mass_g:12.2,
    carbon_atoms:4, eq_used:1.2, eq_stoich:1.0
  }));

  // Solvents
  solventsBox.innerHTML = '';
  solventsBox.appendChild(solventCard({name:'ethyl acetate', mass_g:45.1, boiling_point:77, recovery_pct:60}));
  solventsBox.appendChild(solventCard({name:'water', mass_g:150, boiling_point:100, recovery_pct:0}));

  // Catalysts
  catalystsBox.innerHTML = '';
  catalystsBox.appendChild(catalystCard({name:'sulfuric acid', mw:98.08, mass_g:0.5}));

  // Workup & conditions
  $('#workup_washes').value = 100;   $('#lbl_washes').textContent = '100 g';
  $('#workup_drying').value = 0;     $('#lbl_drying').textContent = '0 g';
  $('#cond_mode').value = 'hotplate';
  $('#cond_time').value = 1.5;       $('#lbl_time').textContent = '1.5 h';
  $('#cond_temp').value = 70;        $('#lbl_temp').textContent = '70 ¬∞C';
  $('#cond_pressure').value = 1;     $('#lbl_pressure').textContent = '1 atm';
  $('#sep_method').value = 'crystallization';
  $('#opt_pmi_recovered').checked = false;
  
  // Update slider fill colors
  updateSliderFill(timeSlider);
  updateSliderFill(tempSlider);
  updateSliderFill(pressureSlider);
  
  // Expand all collapsed sections
  document.querySelectorAll('.section-toggle.collapsed').forEach(toggle => {
    toggle.classList.remove('collapsed');
    let content = toggle.nextElementSibling;
    if (!content || !content.classList.contains('section-content')) {
      content = toggle.parentElement.nextElementSibling;
    }
    if (content && content.classList.contains('section-content')) {
      content.classList.remove('hidden');
    }
  });

  // (optional) auto-run so CE & SF show immediately:
  // runSim();
};

    // Build payload from UI
    function buildPayload() {
      // Get first product card (or use default empty values)
      const productCard = productsBox.children[0];
      const product = productCard ? {
        name: productCard.querySelector('.p_name')?.value || null,
        mw: toNum(productCard.querySelector('.p_mw')?.value),
        actual_mass_g: toNum(productCard.querySelector('.p_mass')?.value),
        carbon_atoms: toNum(productCard.querySelector('.p_c')?.value) || null
      } : {
        name: null,
        mw: NaN,
        actual_mass_g: NaN,
        carbon_atoms: null
      };

const reactants = [...reactantsBox.children].map(r => ({
  name: r.querySelector('.r_name').value || null,
  mw: toNum(r.querySelector('.r_mw').value),
  mass_g: toNum(r.querySelector('.r_mass').value),
  carbon_atoms: toNum(r.querySelector('.r_c')?.value) || null,
  eq_used: toNum(r.querySelector('.r_eu')?.value) || null,
  eq_stoich: toNum(r.querySelector('.r_es')?.value) || null
})).filter(x => (x.mw > 0 && x.mass_g >= 0));

      const solvents = [...solventsBox.children].map(s => ({
        name: s.querySelector('.s_name').value || '',
        mass_g: toNum(s.querySelector('.s_mass').value) || 0,
        boiling_point: toNum(s.querySelector('.s_bp')?.value) || null,
        recovery_pct: toNum(s.querySelector('.s_rec').value) || 0
      })).filter(x => x.name && x.mass_g >= 0);
      
      const catalysts = [...catalystsBox.children].map(c => ({
        mw: toNum(c.querySelector('.c_mw').value),
        mass_g: toNum(c.querySelector('.c_mass').value)
      })).filter(x => (x.mw > 0 && x.mass_g >= 0));

      const workup = {
        aqueous_washes_g: toNum($('#workup_washes').value) || 0,
        organic_rinses_g: 0,
        drying_agents_g: toNum($('#workup_drying').value) || 0
      };
      
      const conditions = {
        temp_C: toNum($('#cond_temp').value) || null,
        time_h: toNum($('#cond_time').value) || 0,
        mode: $('#cond_mode').value
      };
      
      const options = {
        count_recovered_solvent_in_pmi: $('#opt_pmi_recovered').checked
      };
      
      return { product, reactants, solvents, workup, conditions, options };
    }

    // Metrics chart with color coding based on thresholds
    let metricsChart;
    function drawMetricsChart(data) {
      const labels = ['PMI','E-factor','Water (mL/g)','Energy (Wh/g)','SI','CO‚ÇÇ (g/g)'];
      const energy_Wh_per_g = (data.energy_kWh_per_g ?? 0) * 1000;
      
      // Calculate SI
      const b = data.breakdown || {};
      const total_solvent_mass = b.solvent_mass_total_g || 0;
      const product_mass = b.product_mass_g || 0;
      const si = product_mass > 0 ? (total_solvent_mass / product_mass) : null;
      
      // Calculate Carbon Footprint (g CO2 per g product)
      // Rough estimation: energy * 0.5 (kg CO2/kWh) = energy_kWh * 500 g CO2/kWh
      const carbon_footprint = data.energy_kWh_per_g ? (data.energy_kWh_per_g * 500) : null;
      
      const values = [data.pmi ?? null, data.e_factor ?? null, data.water_mL_per_g ?? null, energy_Wh_per_g || null, si, carbon_footprint];
      
      // Color coding based on green chemistry thresholds (lower is better)
      // Green: good, Yellow: ok, Red: needs work
      const thresholds = [
        { good: 10, ok: 30 },    // PMI
        { good: 5, ok: 10 },     // E-factor
        { good: 20, ok: 50 },    // Water (mL/g)
        { good: 5000, ok: 10000 },     // Energy (Wh/g)
        { good: 5, ok: 15 },     // SI (Solvent Intensity)
        { good: 1000, ok: 2500 }  // Carbon Footprint (g CO2/g product)
      ];
      
      const colors = values.map((val, idx) => {
        if (val === null || val === undefined) return '#9CA3AF'; // gray for null
        const t = thresholds[idx];
        if (val < t.good) return '#10B981'; // green-500 (good)
        if (val < t.ok) return '#F59E0B';   // yellow-500 (ok)
        return '#EF4444';                    // red-500 (needs work)
      });
      
      const ctx = document.getElementById('metricsChart').getContext('2d');
      if (metricsChart) {
        metricsChart.data.datasets[0].data = values;
        metricsChart.data.datasets[0].backgroundColor = colors;
        metricsChart.update(); return;
      }
      metricsChart = new Chart(ctx, {
        type: 'bar',
        data: { 
          labels, 
          datasets: [{ 
            label: 'Impact', 
            data: values,
            backgroundColor: colors
          }] 
        },
        options: { 
          responsive: true, 
          plugins: { legend: { display: false } }, 
          scales: { y: { beginAtZero: true } } 
        }
      });
    }
 // Center-number plugin (NOT registered globally)
const DialCenterText = {
  id: 'DialCenterText',
  afterDraw(chart) {
    // Run only for doughnuts created for dials
    if (chart.config.type !== 'doughnut' || !chart.canvas.classList.contains('dial')) return;

    const ds = chart.data.datasets?.[0];
    if (!ds) return;
    const v = Math.round(ds.data?.[0] ?? 0);

    const { ctx, chartArea } = chart;
    if (!chartArea) return;

    ctx.save();
    // auto-scale font to canvas width
    const w = chart.width || 180;
    ctx.font = `600 ${Math.max(14, Math.min(26, w * 0.12))}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`;
    ctx.fillStyle = '#111827';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(v + '%',
      (chartArea.left + chartArea.right) / 2,
      (chartArea.top + chartArea.bottom) / 2
    );
    ctx.restore();
  }
};

let dialCharts = { ae: null, rme: null, ce: null };

function makeDial(canvas, value, color) {
  const ctx = canvas.getContext('2d');
  const v = Math.max(0, Math.min(100, Number(value) || 0));

  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [v, 100 - v],
        borderWidth: 0,
        backgroundColor: [color, '#E5E7EB'],
        cutout: '72%'
      }]
    },
    options: {
      responsive: false,            // <- turn off auto-resize for dials
      maintainAspectRatio: false,   // <- let canvas fill wrapper exactly
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    },
    plugins: [DialCenterText]       // keep plugin per-chart only
  });
}
function updateDial(chart, value, color) {
  if (!chart) return;
  const v = Math.max(0, Math.min(100, Number(value) || 0));
  chart.data.datasets[0].data = [v, 100 - v];
  chart.data.datasets[0].backgroundColor = [color, '#E5E7EB'];
  chart.update();
}

function drawEfficiencyDials(data) {
  const ae  = Number(data.atom_economy_pct)      || 0;
  const rme = Number(data.rme_pct)               || 0;
  const ce  = Number(data.carbon_efficiency_pct) || 0;

  // Color thresholds: good >= 80%, ok >= 60%, needs work < 60%
  const getColor = (val) => {
    if (val >= 80) return '#10B981'; // green
    if (val >= 60) return '#F59E0B'; // yellow
    return '#EF4444'; // red
  };

  if (!dialCharts.ae) {
    dialCharts.ae  = makeDial(document.getElementById('dialAE'),  ae,  getColor(ae));
    dialCharts.rme = makeDial(document.getElementById('dialRME'), rme, getColor(rme));
    dialCharts.ce  = makeDial(document.getElementById('dialCE'),  ce,  getColor(ce));
  } else {
    updateDial(dialCharts.ae,  ae,  getColor(ae));
    updateDial(dialCharts.rme, rme, getColor(rme));
    updateDial(dialCharts.ce,  ce,  getColor(ce));
  }
}


    // Sankey
    function drawSankey(data) {
      const b = data.breakdown || {};
      const reactants   = b.reactant_mass_g || 0;
      const solventTot  = b.solvent_mass_total_g || 0;
      const solventNonR = b.solvent_mass_nonrecovered_g || 0;
      const solventRec  = Math.max(solventTot - solventNonR, 0);
      const aux         = b.auxiliaries_g || 0;
      const product     = b.product_mass_g || 0;
      const waste       = Math.max((b.pmi_numerator_g || 0) - product, 0);

      const nodes = ['Reactants','Solvent (rec)','Solvent (non-rec)','Auxiliaries','Product','Waste'];
      const idx = (n) => nodes.indexOf(n);
      const links = [
        {s:'Reactants',t:'Product',v:Math.min(product,reactants)},
        {s:'Reactants',t:'Waste',  v:Math.max(reactants - Math.min(product,reactants),0)},
        {s:'Solvent (non-rec)',t:'Waste',v:solventNonR},
        {s:'Solvent (rec)',t:'Waste',v:0},
        {s:'Auxiliaries',t:'Waste',v:aux}
      ];

      Plotly.newPlot('sankey', [{
        type: 'sankey',
        orientation: 'h',
        node: { label: nodes },
        link: { source: links.map(l=>idx(l.s)), target: links.map(l=>idx(l.t)), value: links.map(l=>l.v) }
      }], { margin: {t:10,b:10,l:10,r:10} }, { displayModeBar:false });
    }

    // Beaker fill animation (very simple proportional heights)
    function drawBeaker(data) {
      const b = data.breakdown || {};
      const product = b.product_mass_g || 0;
      const nonrec  = Math.max((b.pmi_numerator_g || 0) - product, 0);
      const recSolv = Math.max((b.solvent_mass_total_g || 0) - (b.solvent_mass_nonrecovered_g || 0), 0);

      const total = product + nonrec + recSolv || 1;
      const H = 156; const y0 = 12; // inner height & top offset

      function setRect(id, frac, order) {
        const h = Math.max(frac * H, 0);
        const y = y0 + H - h - order; // stack from bottom upwards
        const r = document.getElementById(id);
        r.setAttribute('y', y);
        r.setAttribute('height', h);
      }
      setRect('fill-product',   product/total, 0);
      setRect('fill-waste',     nonrec/total,  (product/total)*H);
      setRect('fill-recovered', recSolv/total, ((product+nonrec)/total)*H);
    }

    // Render all UI outputs
    function renderAll(data) {
      // number cards
      setTxt('#r_ae',     data.atom_economy_pct ?? '‚Äî');
      setTxt('#r_pmi',    data.pmi ?? '‚Äî');
      setTxt('#r_ef',     data.e_factor ?? '‚Äî');
      setTxt('#r_water',  data.water_mL_per_g ?? '‚Äî');
      const energy_Wh = data.energy_kWh_per_g ? (data.energy_kWh_per_g * 1000).toFixed(2) : '‚Äî';
      setTxt('#r_energy', energy_Wh);
      setTxt('#r_rme', data.rme_pct ?? '‚Äî');
setTxt('#r_ce',  data.carbon_efficiency_pct ?? '‚Äî');
setTxt('#r_sf',  data.sf_overall ?? '‚Äî');
      
      // Calculate Solvent Intensity (SI) = total solvent mass / product mass
      const b = data.breakdown || {};
      const total_solvent_mass = b.solvent_mass_total_g || 0;
      const product_mass = b.product_mass_g || 0;
      const si = product_mass > 0 ? (total_solvent_mass / product_mass).toFixed(2) : '‚Äî';
      setTxt('#r_si', si);
      
      // Calculate Carbon Footprint (g CO2 per g product)
      // Rough estimation: energy * 0.5 (kg CO2/kWh) = energy_kWh * 500 g CO2/kWh
      const cf = data.energy_kWh_per_g ? (data.energy_kWh_per_g * 500).toFixed(2) : '‚Äî';
      setTxt('#r_cf', cf);


      // visuals
      drawMetricsChart(data);
      drawEfficiencyDials(data);
      drawSankey(data);
      drawBeaker(data);

    }

    // Run simulation
    async function runSim() {
      const err = document.getElementById('sim-error');
      err.classList.add('hidden'); err.textContent = '';

      const payload = buildPayload();
      if (!(payload.product.mw > 0 && payload.product.actual_mass_g > 0)) {
        err.textContent = 'Product MW and mass must be > 0.'; err.classList.remove('hidden'); return;
      }
      if (!payload.reactants.length) {
        err.textContent = 'Add at least one reactant with MW and mass.'; err.classList.remove('hidden'); return;
      }

      try {
        const res = await fetch('/api/impact/compute', {
          method: 'POST', headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) { err.textContent = data.detail || 'Server error.'; err.classList.remove('hidden'); return; }
        renderAll(data);
        
        // Show Generate PDF button after successful simulation
        const pdfBtn = document.getElementById('generate-pdf');
        if (pdfBtn) pdfBtn.classList.remove('hidden');
      } catch {
        err.textContent = 'Network error. Is the server running?'; err.classList.remove('hidden');
      }
    }

    document.getElementById('simulate').onclick = runSim;
    document.getElementById('reset').onclick = () => location.reload();
  </script>
</body>
</html>
